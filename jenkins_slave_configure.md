# Инструкция по настройке агентов (слейвов) Jenkins

## Введение

Данная инструкция описывает процесс настройки агентов Jenkins для работы в сегментах Omega и Psi. Агенты позволяют выполнять задачи сборки и тестирования в изолированных средах.

## Предварительные требования

Перед настройкой агентов убедитесь, что:
1. Jenkins мастер успешно запущен и доступен по адресу http://localhost:8081/jenkins
2. Контейнеры агентов запущены с помощью команды `make jenkins-up`
3. У вас есть права администратора в Jenkins

## Шаг 1: Вход в Jenkins

1. Откройте браузер и перейдите по адресу http://localhost:8081/jenkins
2. Войдите в систему, используя учетные данные администратора
   - Если это первый вход, используйте начальный пароль администратора, полученный с помощью команды `make jenkins-setup`

## Шаг 2: Создание агента Omega

1. В панели управления Jenkins перейдите в "Управление Jenkins" (Manage Jenkins)
2. Выберите "Управление узлами и облаками" (Manage Nodes and Clouds)
3. Нажмите "Новый узел" (New Node)
4. Введите имя узла: `omega-agent`
5. Выберите тип "Постоянный агент" (Permanent Agent) и нажмите "OK"
6. Заполните форму настройки агента:
   - **Имя**: omega-agent
   - **Описание**: Агент для выполнения задач в сегменте Omega
   - **Количество исполнителей**: 1
   - **Удаленная корневая директория**: `/home/jenkins/agent`
   - **Метки**: `omega`
   - **Использование**: "Использовать этот узел максимально возможно"
   - **Способ запуска**: "Запустить агент через Java Web Start"
   - **Доступность**: "Поддерживать агент онлайн насколько это возможно"
7. Нажмите "Сохранить"

## Шаг 3: Создание агента Psi

1. Вернитесь в "Управление узлами и облаками"
2. Нажмите "Новый узел" (New Node)
3. Введите имя узла: `psi-agent`
4. Выберите тип "Постоянный агент" (Permanent Agent) и нажмите "OK"
5. Заполните форму настройки агента:
   - **Имя**: psi-agent
   - **Описание**: Агент для выполнения задач в сегменте Psi
   - **Количество исполнителей**: 1
   - **Удаленная корневая директория**: `/home/jenkins/agent`
   - **Метки**: `psi`
   - **Использование**: "Использовать этот узел максимально возможно"
   - **Способ запуска**: "Запустить агент через Java Web Start"
   - **Доступность**: "Поддерживать агент онлайн насколько это возможно"
6. Нажмите "Сохранить"

## Шаг 4: Получение секретных ключей

Для каждого агента необходимо получить секретный ключ:

1. В списке узлов нажмите на имя агента (например, `omega-agent`)
2. На странице агента нажмите на "Запустить агент" (Launch agent)
3. В открывшемся окне нажмите "Копировать команду агента" (Copy agent command)
4. Из скопированной команды извлеките секретный ключ, который находится после параметра `-secret` и перед `-workDir`

## Шаг 5: Запуск агентов

Для запуска агентов используйте команду:

```bash
make jenkins-agents-setup
```

Скрипт запросит секретные ключи для каждого агента, которые вы получили на предыдущем шаге.

Альтернативно, вы можете запустить агенты вручную:

```bash
# Для агента Omega
docker exec jenkins-slave-omega java -jar /usr/share/jenkins/agent.jar -jnlpUrl http://jenkins-master:8080/jenkins/computer/omega-agent/slave-agent.jnlp -secret <СЕКРЕТНЫЙ_КЛЮЧ_OMEGA> -workDir /home/jenkins/agent

# Для агента Psi
docker exec jenkins-slave-psi java -jar /usr/share/jenkins/agent.jar -jnlpUrl http://jenkins-master:8080/jenkins/computer/psi-agent/slave-agent.jnlp -secret <СЕКРЕТНЫЙ_КЛЮЧ_PSI> -workDir /home/jenkins/agent
```

## Шаг 6: Проверка статуса агентов

1. Вернитесь в "Управление узлами и облаками"
2. Убедитесь, что оба агента отображаются как "Онлайн" (зеленый индикатор)
3. Если агент не подключается, проверьте:
   - Правильность введенного секретного ключа
   - Доступность Jenkins мастера из контейнера агента
   - Логи контейнера агента: `docker logs jenkins-slave-omega` или `docker logs jenkins-slave-psi`

## Шаг 7: Тестирование агентов

Для проверки работоспособности агентов создайте тестовый pipeline:

1. В Jenkins нажмите "Новый Item" (New Item)
2. Введите имя: "test-pipeline"
3. Выберите тип "Pipeline" и нажмите "OK"
4. В разделе "Pipeline" вставьте следующий код:

```groovy
pipeline {
    agent none
    
    stages {
        stage('Omega Segment') {
            agent {
                label 'omega'
            }
            steps {
                sh 'echo "Выполнение задачи в сегменте Omega"'
                sh 'hostname'
                sh 'curl -s http://omega-kafka:9092 || echo "Проверка соединения с Kafka в сегменте Omega"'
            }
        }
        
        stage('Psi Segment') {
            agent {
                label 'psi'
            }
            steps {
                sh 'echo "Выполнение задачи в сегменте Psi"'
                sh 'hostname'
                sh 'curl -s http://psi-kafka:9092 || echo "Проверка соединения с Kafka в сегменте Psi"'
            }
        }
    }
}
```

5. Нажмите "Сохранить" и "Собрать сейчас" (Build Now)
6. Проверьте результаты сборки и убедитесь, что задачи выполнились на соответствующих агентах

## Устранение неполадок

### Агент не подключается

1. Проверьте, что контейнер агента запущен:
   ```bash
   docker ps | grep jenkins-slave
   ```

2. Проверьте логи контейнера:
   ```bash
   docker logs jenkins-slave-omega
   ```

3. Убедитесь, что агент может подключиться к мастеру:
   ```bash
   docker exec jenkins-slave-omega ping jenkins-master
   ```

4. Проверьте правильность секретного ключа, получив его заново из веб-интерфейса Jenkins

### Ошибка "Агент отклонен"

1. Удалите агент из Jenkins и создайте его заново
2. Убедитесь, что имя агента в Jenkins совпадает с именем, указанным в переменной окружения `JENKINS_AGENT_NAME` в docker-compose.yaml

### Ошибка "Неверный секретный ключ"

1. Получите новый секретный ключ из веб-интерфейса Jenkins
2. Перезапустите агент с новым ключом

## Дополнительная информация

- Агенты настроены для работы в соответствующих сегментах сети (omega и psi)
- Каждый агент имеет доступ только к сервисам своего сегмента
- Для выполнения задач в определенном сегменте используйте соответствующую метку агента в pipeline 